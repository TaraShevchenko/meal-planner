# ПЛАН МИГРАЦИИ ДАННЫХ ОТ DEV К PRODUCTION

## ОБЗОР

Данный документ описывает процедуру безопасной миграции схемы данных MVP от development окружения к production, обеспечивая сохранность всех пользовательских данных.

## ТЕКУЩЕЕ СОСТОЯНИЕ

### Development Environment
- ✅ Схема данных MVP полностью внедрена
- ✅ Миграция `20250615120108_init_simplified_schema` применена
- ✅ Упрощенные единицы измерения (GRAMS, PIECES, SERVING)
- ✅ Все модели данных созданы и протестированы
- ✅ База данных синхронизирована с Prisma схемой

### Production Environment
- ⚠️ Может содержать старые данные пользователей
- ⚠️ Возможно устаревшая схема базы данных
- ⚠️ Требует осторожной миграции для сохранения данных

## СТРАТЕГИЯ МИГРАЦИИ

### Этап 1: Подготовка и анализ

#### 1.1 Анализ Production базы данных
```bash
# Подключиться к production БД
npx prisma db pull --schema=./prisma/prod-current.prisma

# Сравнить текущую prod схему с новой dev схемой
# Выявить различия и потенциальные конфликты
```

#### 1.2 Создание резервной копии
```bash
# Создать полный бэкап production БД перед миграцией
pg_dump $PRODUCTION_DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql
```

#### 1.3 Анализ существующих данных
- Проверить наличие пользователей в production
- Выявить существующие таблицы и их структуру
- Определить данные, которые нужно сохранить

### Этап 2: Планирование миграции данных

#### 2.1 Сопоставление старых и новых моделей

**Пользователи (Users):**
- Сохранить: id, email, createdAt, updatedAt
- Добавить: firstName, lastName, username, clerkCreatedAt, clerkUpdatedAt
- Синхронизировать с Clerk через webhook

**Ингредиенты (Ingredients):**
- Если существуют: сохранить все данные
- Проверить совместимость полей БЖУ
- Обновить связи с пользователями

**Блюда и рецепты:**
- Мигрировать Recipe → Meal (если существуют)
- Сохранить состав и инструкции
- Обновить связи с ингредиентами

#### 2.2 Стратегия для новых моделей
- QuickMeals: создать пустые таблицы
- MealEntries: создать пустые таблицы
- Families: создать пустые таблицы
- ShoppingLists: создать пустые таблицы
- PortionHistory: создать пустые таблицы
- IngredientPackaging: создать пустые таблицы

### Этап 3: Выполнение миграции

#### 3.1 Подготовка миграционных скриптов

**Скрипт 1: Сохранение существующих данных**
```sql
-- Создать временные таблицы для сохранения данных
CREATE TABLE temp_users_backup AS SELECT * FROM users;
CREATE TABLE temp_ingredients_backup AS SELECT * FROM ingredients;
-- Добавить другие таблицы по необходимости
```

**Скрипт 2: Применение новой схемы**
```bash
# Применить миграции Prisma
npx prisma migrate deploy
```

**Скрипт 3: Восстановление данных**
```sql
-- Восстановить пользователей с новыми полями
INSERT INTO users (id, email, createdAt, updatedAt, firstName, lastName)
SELECT id, email, createdAt, updatedAt, NULL, NULL
FROM temp_users_backup;

-- Восстановить ингредиенты
INSERT INTO ingredients SELECT * FROM temp_ingredients_backup;
```

#### 3.2 Пошаговое выполнение

1. **Создание staging окружения**
   ```bash
   # Создать копию production БД для тестирования
   # Применить миграции на staging
   # Протестировать восстановление данных
   ```

2. **Maintenance режим**
   ```bash
   # Включить maintenance режим на production
   # Остановить все операции записи
   ```

3. **Выполнение миграции**
   ```bash
   # Создать финальный бэкап
   # Применить миграционные скрипты
   # Проверить целостность данных
   ```

4. **Проверка и запуск**
   ```bash
   # Проверить все таблицы и связи
   # Запустить приложение
   # Протестировать основной функционал
   ```

### Этап 4: Пост-миграционные действия

#### 4.1 Синхронизация с Clerk
```bash
# Настроить webhook для синхронизации пользователей
# Обновить данные пользователей из Clerk
# Проверить корректность авторизации
```

#### 4.2 Валидация данных
- Проверить количество пользователей до/после миграции
- Проверить целостность ингредиентов и рецептов
- Протестировать создание новых записей

#### 4.3 Мониторинг
- Отслеживать ошибки в логах
- Мониторить производительность БД
- Проверить работу всех API endpoints

## ПЛАН ОТКАТА (ROLLBACK)

### В случае критических ошибок:

1. **Немедленный откат**
   ```bash
   # Остановить приложение
   # Восстановить БД из бэкапа
   psql $PRODUCTION_DATABASE_URL < backup_YYYYMMDD_HHMMSS.sql
   ```

2. **Анализ проблем**
   - Изучить логи ошибок
   - Выявить причины сбоя
   - Подготовить исправления

3. **Повторная попытка**
   - Исправить выявленные проблемы
   - Протестировать на staging
   - Повторить миграцию

## КОНТРОЛЬНЫЕ ТОЧКИ

### Перед миграцией:
- [ ] Создан полный бэкап production БД
- [ ] Протестирована миграция на staging
- [ ] Подготовлены скрипты отката
- [ ] Уведомлены пользователи о maintenance

### Во время миграции:
- [ ] Включен maintenance режим
- [ ] Выполнены миграционные скрипты
- [ ] Проверена целостность данных
- [ ] Протестирован основной функционал

### После миграции:
- [ ] Синхронизированы пользователи с Clerk
- [ ] Проверена работа всех API
- [ ] Мониторинг не показывает ошибок
- [ ] Пользователи уведомлены о завершении

## ВРЕМЕННЫЕ РАМКИ

- **Подготовка:** 2-4 часа
- **Выполнение миграции:** 1-2 часа
- **Проверка и тестирование:** 1-2 часа
- **Общее время maintenance:** 4-8 часов

## КОНТАКТЫ И ОТВЕТСТВЕННОСТЬ

- **Ответственный за миграцию:** [Указать ответственного]
- **Backup администратор:** [Указать контакт]
- **Контакт для экстренных случаев:** [Указать контакт]

## ЗАКЛЮЧЕНИЕ

Данный план обеспечивает безопасную миграцию схемы данных MVP с минимальным риском потери пользовательских данных. Критически важно следовать всем этапам и контрольным точкам для успешного выполнения миграции.

---

**Дата создания:** $(date +%Y-%m-%d)  
**Версия:** 1.0  
**Статус:** Готов к выполнению